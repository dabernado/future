# Compile the `emitted.s` file that's generated by the tests together with the
# `runtime.c` into an executable.
#
# -m32 forces to compile for 32bit target, this prevents accidental surprises.
#
# `-g3 -ggdb3` generates as much debug symbols as possible, notably the latter
# allows the use of macros in gdb prompt. As of now, only GCC seems to support
# this option.
#
# Omitting the frame pointer with `-fomit-frame-pointer` removes the standard
# function preamble and post when not needed. This makes the assembly slightly
# easier to read and harder to debug.
#
# `-fno-asynchronous-unwind-tables` gets rid of all the '.cfi' directives from
# the generated asm.

.PHONY: emitted
emitted: runtime.c emitted.ll
	clang \
		-Wall \
		-Wno-implicit-function-declaration \
		-Wno-override-module \
		-O3 runtime.c emitted.ll \
		-o emitted

.PHONY: test
test:
	echo '(test-all)' | scheme compiler.scm --quiet

.PHONY: clean
clean:
	rm -f emitted.ll emitted emitted.out
